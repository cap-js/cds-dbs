name: run tests in cap/dev setup locally

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  issues: write # to create comments in PRs the issues API is used
  pull-requests: write

jobs:
  fail-fast:
    runs-on: ubuntu-latest

    steps:
      # 0. Locate an existing guidance comment (if any)
      - name: Find guidance comment
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'Until cds9 is released'

      # 1. Create the comment if it doesn't exist, or update it if it does
      - name: Create or update guidance comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}   # empty on first run â†’ create; otherwise update
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace                               # overwrite the previous body
          body: |
            â—ï¸Until cds9 is released, we need to ensure code integrity by local testing.  

            Please follow these steps to run your changes against all tests in our pipeline:
            1. Go to [our matrix tests](https://github.tools.sap/cap/.github/actions/workflows/matrix.yml).
            2. Click **â€œRun workflowâ€**.
            3. For **â€œspecific branches for the cds packagesâ€** insert `cds-dbs:${{ github.event.pull_request.head.ref }}` and execute the workflow.  

            Once the matrix tests are **green**, confirm it here.  
            An admin will then merge your PR. ğŸ˜Š

      # 2. Fail the workflow on purpose so the PR stays blocked
      - name: Fail immediately
        run: |
          echo "Failing intentionally until cds9 release."
          exit 1
